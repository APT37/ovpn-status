when:
  - event: push
    branch: master

skip_clone: true

steps:
  - name: clone
    image: fish
    commands:
      - git clone $CI_REPO_CLONE_SSH_URL .

  - name: toolchain
    image: fish
    environment:
      RUST_TOOLCHAIN_PATH:
        from_secret: rust_toolchain_path
    commands:
      - rustup toolchain link woodpecker $RUST_TOOLCHAIN_PATH
      - rustup default woodpecker

  - name: build
    image: fish
    environment:
      CARGO_HOME:
        from_secret: cargo_home
      CARGO_TARGET_DIR:
        from_secret: cargo_target_dir
    commands:
      - cargo build --release

  - name: PKGBUILD
    image: fish
    environment:
      ARCH_REPO_DIR:
        from_secret: arch_repo_dir
      ARCH_REPO_NAME:
        from_secret: arch_repo_name
      CARGO_TARGET_DIR:
        from_secret: cargo_target_dir
    commands:
      - ln -s $CARGO_TARGET_DIR target
      - makepkg --nodeps
      - mv (makepkg --packagelist) $ARCH_REPO_DIR
      - for pkg in (makepkg --packagelist); repo-add $ARCH_REPO_DIR/$ARCH_REPO_NAME.db.tar.zst $ARCH_REPO_DIR/(string split -r -m 1 '/' $pkg | tail -1); end